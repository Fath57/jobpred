pipeline {
    agent any

    environment {
        // Auto-detect environment from branch
        ENV_NAME = "${env.BRANCH_NAME == 'main' || env.BRANCH_NAME == 'master' || env.BRANCH_NAME == 'production' ? 'production' : 'development'}"
        IS_PRODUCTION = "${env.BRANCH_NAME == 'main' || env.BRANCH_NAME == 'master' || env.BRANCH_NAME == 'production' ? 'true' : 'false'}"

        // Deployment paths
        DEPLOY_BASE = "/var/www/jobprep"
        DEPLOY_PATH = "${DEPLOY_BASE}/${ENV_NAME}"
        APP_PATH = "${DEPLOY_PATH}/app"

        // Docker Compose files
        COMPOSE_FILES = "${IS_PRODUCTION == 'true' ? 'docker-compose.yml -f docker-compose.production.yml' : 'docker-compose.yml -f docker-compose.development.yml'}"
        ENV_FILE = "${IS_PRODUCTION == 'true' ? '.env.production' : '.env.development'}"
    }

    triggers {
        pollSCM('H/5 * * * *')
    }

    options {
        timeout(time: 30, unit: 'MINUTES')
        skipStagesAfterUnstable()
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
    }

    stages {
        stage('ğŸ“‹ Deployment Info') {
            steps {
                script {
                    echo """
                    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                    â•‘     ğŸš€ DEPLOYMENT STARTING            â•‘
                    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                    Environment: ${ENV_NAME.toUpperCase()}
                    Branch: ${env.BRANCH_NAME}
                    Build: #${env.BUILD_NUMBER}
                    Deploy Path: ${APP_PATH}
                    Workspace: ${WORKSPACE}
                    Compose Files: ${COMPOSE_FILES}
                    Env File: ${ENV_FILE}

                    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    """
                }
            }
        }

        stage('ğŸ“¥ Checkout Code') {
            steps {
                script {
                    echo "ğŸ”„ Checking out code from repository..."

                    // Clean workspace before checkout
                    cleanWs()

                    // Checkout code from SCM
                    checkout scm

                    echo "âœ… Code checked out successfully"

                    // Verify important files exist
                    sh """
                        echo ""
                        echo "ğŸ“‚ Verifying repository structure..."

                        if [ -f "docker-compose.yml" ]; then
                            echo "âœ… docker-compose.yml found"
                        else
                            echo "âŒ docker-compose.yml NOT found"
                            exit 1
                        fi

                        if [ -f "docker-compose.${ENV_NAME}.yml" ]; then
                            echo "âœ… docker-compose.${ENV_NAME}.yml found"
                        else
                            echo "âŒ docker-compose.${ENV_NAME}.yml NOT found"
                            exit 1
                        fi

                        if [ -f "${ENV_FILE}" ]; then
                            echo "âœ… ${ENV_FILE} found"
                        else
                            echo "âŒ ${ENV_FILE} NOT found"
                            exit 1
                        fi

                        echo ""
                        echo "ğŸ“Š Repository contents:"
                        ls -lah
                    """
                }
            }
        }

        stage('âš ï¸  Production Approval') {
            when {
                expression { IS_PRODUCTION == 'true' }
            }
            steps {
                timeout(time: 10, unit: 'MINUTES') {
                    input message: "ğŸš€ Deploy to PRODUCTION?",
                          ok: "Deploy Now",
                          submitter: "admin,devops"
                }
            }
        }

        stage('ğŸ” Pre-deployment Check') {
            steps {
                script {
                    echo "ğŸ” Checking system requirements..."
                    sh """
                        echo "âœ… Running from Jenkins container"
                        echo ""

                        echo "ğŸ³ Docker version:"
                        docker --version || { echo "âŒ Docker not accessible"; exit 1; }
                        echo ""

                        echo "ğŸ“¦ Docker Compose version:"
                        docker compose version || { echo "âŒ Docker Compose not accessible"; exit 1; }
                        echo ""

                        echo "ğŸ’¾ Disk space:"
                        df -h / | tail -1
                        echo ""

                        echo "ğŸ” Available memory:"
                        free -h
                        echo ""
                    """
                }
            }
        }

        stage('ğŸ”§ Prepare Deployment Directory') {
            steps {
                script {
                    echo "ğŸ”§ Setting up deployment directory structure..."
                    sh """
                        # Create main deployment directory
                        mkdir -p ${APP_PATH}
                        mkdir -p ${DEPLOY_PATH}/backups

                        echo "âœ… Directory structure ready"
                    """
                }
            }
        }

        stage('ğŸ’¾ Backup Current Deployment') {
            when {
                expression {
                    return fileExists("${APP_PATH}/docker-compose.yml")
                }
            }
            steps {
                script {
                    echo "ğŸ’¾ Creating backup of current deployment..."
                    sh """
                        BACKUP_NAME="backup_\$(date +%Y%m%d_%H%M%S)"
                        BACKUP_PATH="${DEPLOY_PATH}/backups/\${BACKUP_NAME}"

                        echo "ğŸ“¦ Creating backup: \${BACKUP_NAME}"
                        cp -r ${APP_PATH} \${BACKUP_PATH}

                        # Keep only last 5 backups
                        cd ${DEPLOY_PATH}/backups
                        ls -t | tail -n +6 | xargs -r rm -rf

                        echo "âœ… Backup created: \${BACKUP_PATH}"
                        echo "ğŸ“Š Backup size: \$(du -sh \${BACKUP_PATH} | cut -f1)"
                    """
                }
            }
        }

        stage('ğŸ›‘ Stop Existing Containers') {
            steps {
                script {
                    echo "ğŸ›‘ Stopping existing containers..."

                    sh """
                        # Check if app directory and docker-compose files exist
                        if [ ! -d "${APP_PATH}" ] || [ ! -f "${APP_PATH}/docker-compose.yml" ]; then
                            echo "â„¹ï¸  No existing deployment found"
                            exit 0
                        fi

                        cd ${APP_PATH}

                        # Check if containers are running
                        if docker compose ps -q 2>/dev/null | grep -q .; then
                            echo "ğŸ›‘ Stopping and removing containers..."
                            docker compose -f ${COMPOSE_FILES} --env-file ${ENV_FILE} down --remove-orphans
                            echo "âœ… Containers stopped and removed"
                        else
                            echo "â„¹ï¸  No containers running"
                        fi
                    """
                }
            }
        }

        stage('ğŸ“¤ Deploy Application Files') {
            steps {
                script {
                    echo "ğŸ“¤ Deploying application files..."
                    sh """
                        echo "ğŸ—‘ï¸  Cleaning deployment directory..."
                        rm -rf ${APP_PATH}/*

                        echo "ğŸ“¦ Copying files from workspace to deployment directory..."
                        cd ${WORKSPACE}

                        # Use rsync for better control, fallback to tar if rsync not available
                        if command -v rsync &> /dev/null; then
                            echo "Using rsync..."
                            rsync -av \
                                --exclude='.git' \
                                --exclude='node_modules' \
                                --exclude='.env*' \
                                --exclude='*.log' \
                                --exclude='.jenkins' \
                                --exclude='*@tmp' \
                                --exclude='backups' \
                                ./ ${APP_PATH}/
                        else
                            echo "Using tar..."
                            tar --exclude='.git' \
                                --exclude='node_modules' \
                                --exclude='.env*' \
                                --exclude='*.log' \
                                --exclude='.jenkins' \
                                --exclude='*@tmp' \
                                --exclude='backups' \
                                -cf - . | tar -xf - -C ${APP_PATH}/
                        fi

                        echo ""
                        echo "âœ… Files deployed to ${APP_PATH}"
                        echo "ğŸ“Š Deployment size: \$(du -sh ${APP_PATH} | cut -f1)"

                        echo ""
                        echo "ğŸ” Verifying critical files..."
                        cd ${APP_PATH}
                        ls -lh docker-compose*.yml ${ENV_FILE}
                    """
                }
            }
        }

        stage('ğŸ“ Configure Environment') {
            steps {
                script {
                    echo "ğŸ“ Configuring environment..."
                    sh """
                        cd ${APP_PATH}

                        # Verify environment file exists
                        if [ ! -f "${ENV_FILE}" ]; then
                            echo "âŒ Environment file not found: ${ENV_FILE}"
                            echo "Available files:"
                            ls -la .env*
                            exit 1
                        fi

                        # Set proper permissions
                        chmod 644 ${ENV_FILE}

                        echo "âœ… Environment configured for ${ENV_NAME}"
                        echo "ğŸ“„ Using: ${ENV_FILE}"
                    """
                }
            }
        }

        stage('ğŸ³ Build Docker Images') {
            steps {
                script {
                    echo "ğŸ”¨ Building Docker images..."
                    sh """
                        cd ${APP_PATH}

                        echo "ğŸ³ Building with: ${COMPOSE_FILES}"
                        docker compose -f ${COMPOSE_FILES} --env-file ${ENV_FILE} build --no-cache

                        echo "âœ… Images built successfully"
                    """
                }
            }
        }

        stage('ğŸš€ Start Containers') {
            steps {
                script {
                    echo "ğŸš€ Starting Docker containers..."
                    sh """
                        cd ${APP_PATH}

                        docker compose -f ${COMPOSE_FILES} --env-file ${ENV_FILE} up -d

                        echo "âœ… Containers started"
                    """
                }
            }
        }

        stage('ğŸ¥ Health Check') {
            steps {
                script {
                    echo "ğŸ¥ Performing health checks..."

                    def maxAttempts = 30
                    def checkInterval = 2
                    def healthy = false

                    for (int attempt = 1; attempt <= maxAttempts; attempt++) {
                        try {
                            def result = sh(
                                script: """
                                    cd ${APP_PATH}
                                    docker compose -f ${COMPOSE_FILES} --env-file ${ENV_FILE} ps --format json 2>/dev/null | grep -c '"State":"running"' || echo 0
                                """,
                                returnStdout: true
                            ).trim()

                            def runningCount = result.isInteger() ? result.toInteger() : 0

                            if (runningCount > 0) {
                                echo "âœ… ${runningCount} container(s) running (attempt ${attempt}/${maxAttempts})"

                                // Wait for stability
                                if (attempt >= 5) {
                                    healthy = true
                                    echo "âœ… Containers are stable and healthy"
                                    break
                                }
                            } else {
                                echo "â³ Waiting for containers (attempt ${attempt}/${maxAttempts})..."
                            }

                            sleep checkInterval

                        } catch (Exception e) {
                            echo "âš ï¸  Health check attempt ${attempt}/${maxAttempts} failed: ${e.getMessage()}"
                            sleep checkInterval
                        }
                    }

                    if (!healthy) {
                        echo "âŒ Health check failed - containers not running properly"

                        sh """
                            cd ${APP_PATH}

                            echo ""
                            echo "ğŸ³ Container status:"
                            docker compose -f ${COMPOSE_FILES} --env-file ${ENV_FILE} ps

                            echo ""
                            echo "ğŸ“‹ Container logs:"
                            docker compose -f ${COMPOSE_FILES} --env-file ${ENV_FILE} logs --tail=100
                        """

                        error("Health check failed - deployment unsuccessful")
                    }
                }
            }
        }

        stage('ğŸ§ª Smoke Tests') {
            steps {
                script {
                    echo "ğŸ§ª Running smoke tests..."
                    sh """
                        cd ${APP_PATH}

                        echo "ğŸ” Checking container processes..."
                        docker compose -f ${COMPOSE_FILES} --env-file ${ENV_FILE} ps

                        echo ""
                        echo "ğŸ’» Checking container resource usage..."
                        docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}" \
                            \$(docker compose -f ${COMPOSE_FILES} --env-file ${ENV_FILE} ps -q)

                        echo ""
                        echo "âœ… Smoke tests passed"
                    """
                }
            }
        }

        stage('ğŸ§¹ Cleanup') {
            steps {
                script {
                    echo "ğŸ§¹ Cleaning up unused Docker resources..."
                    sh """
                        echo "ğŸ—‘ï¸  Removing dangling images..."
                        docker image prune -f

                        echo "ğŸ—‘ï¸  Removing unused volumes..."
                        docker volume prune -f

                        echo "âœ… Cleanup completed"
                    """
                }
            }
        }

        stage('ğŸ“Š Deployment Summary') {
            steps {
                script {
                    sh """
                        cd ${APP_PATH}

                        echo ""
                        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                        echo "â•‘       ğŸ“Š DEPLOYMENT SUMMARY            â•‘"
                        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                        echo ""

                        echo "ğŸ“ Environment: ${ENV_NAME.toUpperCase()}"
                        echo "ğŸ“ Deployment Path: ${APP_PATH}"
                        echo "ğŸŒ¿ Branch: ${env.BRANCH_NAME}"
                        echo "ğŸ—ï¸  Build: #${env.BUILD_NUMBER}"
                        echo ""

                        echo "ğŸ³ Running Containers:"
                        docker compose -f ${COMPOSE_FILES} --env-file ${ENV_FILE} ps
                        echo ""

                        echo "ğŸ“‹ Recent Logs (last 20 lines):"
                        docker compose -f ${COMPOSE_FILES} --env-file ${ENV_FILE} logs --tail=20
                        echo ""
                    """
                }
            }
        }
    }

    post {
        always {
            script {
                def duration = currentBuild.durationString.replace(' and counting', '')
                echo """
                â±ï¸  Build Duration: ${duration}
                ğŸ“… Completed: ${new Date()}
                """
            }
        }

        success {
            script {
                echo """
                â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                â•‘     ğŸ‰ DEPLOYMENT SUCCESSFUL           â•‘
                â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                Environment: ${ENV_NAME.toUpperCase()}
                Branch: ${env.BRANCH_NAME}
                Build: #${env.BUILD_NUMBER}
                Path: ${APP_PATH}

                âœ… All stages completed successfully
                ğŸ³ Docker containers are running

                ğŸ“‹ Useful Commands:
                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                # Navigate to deployment
                cd ${APP_PATH}

                # View container status
                docker compose -f ${COMPOSE_FILES} --env-file ${ENV_FILE} ps

                # View logs
                docker compose -f ${COMPOSE_FILES} --env-file ${ENV_FILE} logs -f

                # Restart containers
                docker compose -f ${COMPOSE_FILES} --env-file ${ENV_FILE} restart

                # Stop containers
                docker compose -f ${COMPOSE_FILES} --env-file ${ENV_FILE} down

                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                """
            }
        }

        failure {
            script {
                echo """
                â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                â•‘      âŒ DEPLOYMENT FAILED              â•‘
                â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                Environment: ${ENV_NAME.toUpperCase()}
                Branch: ${env.BRANCH_NAME}
                Build: #${env.BUILD_NUMBER}

                ğŸ” Troubleshooting Steps:
                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                1. Check console output:
                   ${env.BUILD_URL}console

                2. Check container logs:
                   cd ${APP_PATH}
                   docker compose -f ${COMPOSE_FILES} --env-file ${ENV_FILE} logs

                3. Check container status:
                   docker compose -f ${COMPOSE_FILES} --env-file ${ENV_FILE} ps

                4. Rollback to previous version:
                   cd ${DEPLOY_PATH}/backups
                   ls -lt
                   # Copy the latest backup back to ${APP_PATH}

                5. Check disk space:
                   df -h

                6. Check Docker status:
                   docker ps -a
                   docker system df

                â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                """
            }
        }

        unstable {
            script {
                echo "âš ï¸  Build is unstable - please review the logs"
            }
        }

        aborted {
            script {
                echo """
                âš ï¸  Deployment was aborted

                The deployment process was manually stopped or timed out.
                You may need to clean up manually:

                cd ${APP_PATH}
                docker compose -f ${COMPOSE_FILES} --env-file ${ENV_FILE} down
                """
            }
        }
    }
}